# 要件定義書: Obsidian AI Assistant プラグイン

> 最終更新: 2026-02-13
> ステータス: ドラフト

---

## 1. プロジェクト概要

### 1.1 目的
Obsidian上でAIチャット・テキスト補完・ファイル操作を統合的に提供するプラグインを開発する。
ユーザーがVault内のナレッジを活用しながら、AIとの対話を通じてノート作成を効率化することを目指す。

### 1.2 プラグイン名
未定 (仮称: `obsidian-ai-assistant`)

### 1.3 技術スタック

| 項目 | 選定 | 理由 |
|------|------|------|
| 言語 | TypeScript | Obsidian公式推奨。型安全性 |
| ビルド | esbuild | Obsidian公式サンプルと同じ構成。高速ビルド |
| UIフレームワーク | React 18 | チャットUIの状態管理に適している |
| AIバックエンド | Google Gemini API | `@google/genai` パッケージ (新SDK) |

---

## 2. 機能要件

### F1: サイドバーAIチャット

| 項目 | 内容 |
|------|------|
| 概要 | Obsidianの右サイドバーにAIチャットパネルを表示する |
| UIの実現方法 | ObsidianのItemViewをサブクラス化し、React をマウントする |
| メッセージ表示 | ユーザーとAIのメッセージを時系列で表示 |
| ストリーミング | AIの応答をチャンク単位でリアルタイム表示する |
| 入力 | テキストエリア + 送信ボタン。Enterで送信(Shift+Enterで改行) |
| 履歴 | 同一セッション内の会話履歴をAIに送信し、文脈を維持する |

**Obsidian APIの対応箇所:**
- `ItemView` クラス: サイドバーのカスタムビューを作成するための基底クラス
- `Plugin.registerView()`: プラグインにビューを登録
- `Workspace.getRightLeaf()`: 右サイドバーにビューを配置

### F2: チャット内容の保存

| 項目 | 内容 |
|------|------|
| 概要 | チャットセッションをMarkdownファイルとしてVaultに保存する |
| 保存形式 | そのまま保存 (全メッセージ) / 要約して保存 (AIが要約生成) |
| 保存先 | 設定で指定するフォルダ (デフォルト: `AI Chats/`) |
| ファイル名 | 日時 + チャットの先頭メッセージから自動生成 |
| トリガー | コマンドパレットから実行 / チャットUI上のボタン |

**Obsidian APIの対応箇所:**
- `Vault.create(path, content)`: 新規ファイル作成
- `Vault.createFolder(path)`: フォルダ作成
- `Plugin.addCommand()`: コマンドパレットにコマンド追加

### F3: チャットからのファイル操作

| 項目 | 内容 |
|------|------|
| 概要 | チャット上の指示でVault内ファイルを新規作成・編集する |
| 対応操作 | ファイル新規作成 / 既存ファイル編集 / ファイルへの追記 |
| 確認フロー | AIがファイル操作を提案 → ユーザーが確認ダイアログで承認 → 実行 |
| 安全性 | ユーザーの明示的な承認なしにファイルを変更しない |

**Obsidian APIの対応箇所:**
- `Vault.create(path, content)`: ファイル新規作成
- `Vault.modify(file, content)`: 既存ファイルの内容を上書き
- `Vault.process(file, fn)`: アトミックな読み取り→変更→保存
- `Vault.getAbstractFileByPath(path)`: パスからファイルオブジェクト取得

### F4: ナレッジファイルの活用

| 項目 | 内容 |
|------|------|
| 概要 | Vault内の他ファイルをコンテキストとしてAIに渡し、回答を生成する |
| ファイル選択 | チャットUI上でファイルを検索・選択する |
| 上限 | 設定で指定 (デフォルト: 最大5ファイル) |
| 送信方法 | 選択ファイルの内容をGemini APIのプロンプトに含める |

**Obsidian APIの対応箇所:**
- `Vault.getMarkdownFiles()`: Vault内の全Markdownファイル一覧
- `Vault.read(file)`: ファイル内容の読み取り
- `TFile`: ファイルを表すオブジェクト

### F5: AIインライン補完

| 項目 | 内容 |
|------|------|
| 概要 | エディタ上でAIが文章の続きを予測し、補完候補として表示する |
| トリガー | ユーザーがタイピングを止めた後 (デバウンス: デフォルト500ms) |
| 表示 | Obsidian標準のサジェストポップアップ |
| 挿入 | Tab/Enterで候補を挿入。Escで却下 |
| ON/OFF | 設定画面で有効/無効を切り替え可能 |

**Obsidian APIの対応箇所:**
- `EditorSuggest` クラス: エディタ上のサジェスト機能を実装する基底クラス
  - `onTrigger()`: サジェストを表示する条件を判定 (キー入力ごとに呼ばれる)
  - `getSuggestions()`: 候補のリストを返す
  - `renderSuggestion()`: 各候補の表示を描画
  - `selectSuggestion()`: 候補選択時にテキストを挿入
- `Plugin.registerEditorSuggest()`: プラグインにEditorSuggestを登録

---

## 3. 非機能要件

### 3.1 パフォーマンス
- ストリーミング応答により、最初のトークンが表示されるまでの体感待ち時間を最小化
- インライン補完はデバウンスでAPI呼び出しを抑制し、エディタの操作感を損なわない
- 長いチャット履歴でもUIがスムーズにスクロール

### 3.2 セキュリティ
- APIキーはObsidianのプラグインデータ保存機能で管理 (`Plugin.saveData()`)
- ファイル操作は必ずユーザー確認を経由
- ファイルパスのバリデーション (Vault外への書き込み防止)

### 3.3 ユーザビリティ
- Obsidianのネイティブなルック&フィールに合わせたUI
- ダークモード/ライトモード両対応
- コマンドパレットからの主要操作アクセス

---

## 4. 設定項目

| 設定名 | 型 | デフォルト値 | 説明 |
|--------|-----|------------|------|
| APIキー | string | `""` | Gemini APIキー |
| モデル | dropdown | `gemini-2.0-flash` | 使用するGeminiモデル |
| システムプロンプト | textarea | (後述) | AIの振る舞いを定義するプロンプト |
| インライン補完 | toggle | `true` | 補完機能のON/OFF |
| デバウンス時間 | number | `500` (ms) | 補完のAPI呼び出し間隔 |
| 最大ナレッジファイル数 | number | `5` | 同時にコンテキストに含められるファイル数 |
| チャット保存先 | string | `AI Chats` | チャット保存フォルダのパス |
| ファイル操作の確認 | toggle | `true` | ファイル操作前の確認ダイアログ |
| ストリーミング | toggle | `true` | ストリーミング応答のON/OFF |

---

## 5. Obsidianプラグインの基本構造 (参考)

Obsidianプラグインは以下の仕組みで動作する:

```
Obsidianアプリ
├── Vault (ユーザーのノート群)
├── Workspace (エディタ、サイドバー等のレイアウト)
│   ├── Left Sidebar
│   ├── Editor (MarkdownView)
│   └── Right Sidebar ← ここにチャットUIを配置
└── Plugin System
    └── 各プラグイン
        ├── onload()   … プラグイン有効化時に呼ばれる。ビューやコマンドを登録
        ├── onunload() … プラグイン無効化時に呼ばれる。クリーンアップ
        ├── loadData() / saveData() … プラグイン設定の読み書き
        └── app プロパティ … Obsidianアプリ全体へのアクセス
            ├── app.vault    … ファイル操作
            └── app.workspace … UI操作
```

### 主要な登場クラス

| クラス | 役割 | このプラグインでの使い方 |
|--------|------|------------------------|
| `Plugin` | プラグインの基底クラス | main.tsでサブクラス化。全体のエントリポイント |
| `ItemView` | カスタムビューの基底クラス | サイドバーチャットのビューとして使用 |
| `PluginSettingTab` | 設定画面の基底クラス | APIキー等の設定UIを提供 |
| `EditorSuggest` | エディタサジェストの基底クラス | インライン補完の実装に使用 |
| `TFile` | Vault内のファイルを表すオブジェクト | ナレッジ読み取り、ファイル操作の対象 |
| `Vault` | ファイル操作API | 読み取り・作成・編集の全操作 |
| `Workspace` | UI操作API | サイドバーへのビュー配置 |

---

## 6. 実装フェーズ (概要)

| Phase | 内容 | ゴール |
|-------|------|--------|
| 1 | 基盤構築 & 基本チャットUI | サイドバーにReactチャットが表示される |
| 2 | 設定画面 & Gemini API接続 | 実際のAI応答がストリーミング表示される |
| 3 | ナレッジファイル活用 | Vaultファイルを参照した回答が得られる |
| 4 | チャット保存 | チャットをMarkdownとして保存できる |
| 5 | ファイル操作 | AIの指示でファイルを作成・編集できる |
| 6 | インライン補完 | エディタ上でAI補完が動作する |
| 7 | 仕上げ | セッション永続化、パフォーマンス最適化 |

各フェーズの詳細な実装計画は、着手時に別途ドキュメントを作成する。

---

## 7. 用語集

| 用語 | 説明 |
|------|------|
| Vault | Obsidianが管理するフォルダ。ユーザーのノートが格納される |
| Leaf | Obsidianのワークスペース内の1つのパネル |
| ItemView | Leafに表示されるカスタムビューの基底クラス |
| EditorSuggest | エディタ上のオートコンプリート機能の基底クラス |
| Ribbon | Obsidian左端のアイコンバー |
| Command Palette | Ctrl+P で開くコマンド一覧 |
| Community Plugin | サードパーティ製プラグイン (今回作るもの) |
